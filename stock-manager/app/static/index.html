<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Manager</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f0f0f;
            color: #e0e0e0;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 16px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #222;
            margin-bottom: 16px;
        }
        .header h1 { font-size: 18px; color: #fff; font-weight: 600; }
        .header small { color: #555; font-size: 12px; }

        /* Stats row */
        .stats {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        .stat {
            flex: 1;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        .stat-value { font-size: 24px; font-weight: 700; color: #fff; }
        .stat-label { font-size: 11px; color: #666; text-transform: uppercase; margin-top: 2px; }
        .stat.warning .stat-value { color: #f59e0b; }

        /* Sections */
        .section {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            user-select: none;
        }
        .section-header h2 { font-size: 14px; font-weight: 600; color: #aaa; text-transform: uppercase; letter-spacing: 0.5px; }
        .section-header .toggle { color: #555; font-size: 12px; }
        .section-body { padding: 0 16px 16px; }
        .section.collapsed .section-body { display: none; }
        .section.collapsed .toggle::after { content: 'mostrar'; }
        .section:not(.collapsed) .toggle::after { content: 'ocultar'; }

        /* Shopping list */
        .shopping-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #222;
            font-size: 14px;
        }
        .shopping-item:last-child { border-bottom: none; }
        .shopping-item .name { color: #e0e0e0; }
        .shopping-item .qty { color: #f59e0b; font-weight: 600; font-size: 13px; }
        .shopping-item .expiry-warn { color: #ef4444; font-size: 12px; }
        .shopping-empty { color: #444; font-size: 14px; padding: 8px 0; }

        /* Scanner */
        .barcode-input {
            display: flex;
            gap: 8px;
        }
        .barcode-input input {
            flex: 1;
            background: #111;
            border: 1px solid #333;
            color: #fff;
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 15px;
        }
        .barcode-input input:focus { outline: none; border-color: #555; }
        .barcode-input input::placeholder { color: #444; }

        .camera-row {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        #scanner-container {
            width: 100%;
            max-width: 400px;
            margin: 12px auto;
            border-radius: 8px;
            overflow: hidden;
        }

        /* Buttons */
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .btn:active { opacity: 0.7; }
        .btn-primary { background: #333; color: #fff; }
        .btn-add { background: #166534; color: #4ade80; }
        .btn-remove { background: #7f1d1d; color: #f87171; }

        /* Product form */
        #product-action { margin-top: 12px; }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .form-grid .full { grid-column: 1 / -1; }
        .form-group label { display: block; font-size: 12px; color: #666; margin-bottom: 4px; }
        .form-group input, .form-group select {
            width: 100%;
            background: #111;
            border: 1px solid #333;
            color: #fff;
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 14px;
        }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #555; }
        .form-group select option { background: #1a1a1a; }
        .form-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .form-actions .btn { flex: 1; }

        #scanned-code {
            background: #1a2e1a;
            border: 1px solid #2d4a2d;
            color: #4ade80;
            padding: 8px 12px;
            border-radius: 6px;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        /* Product list */
        .product-row {
            padding: 10px 0;
            border-bottom: 1px solid #222;
        }
        .product-row:last-child { border-bottom: none; }
        .product-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }
        .product-main { flex: 1; min-width: 0; }
        .product-main .name { font-size: 15px; color: #e0e0e0; font-weight: 500; }
        .product-main .meta { font-size: 12px; color: #555; margin-top: 2px; }
        .product-stock {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }
        .stock-num {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
            min-width: 28px;
            text-align: center;
        }
        .stock-num.low { color: #f59e0b; }
        .btn-round {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid #333;
            background: #222;
            color: #aaa;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
        }
        .btn-round:active { opacity: 0.6; }
        .btn-round.add { border-color: #166534; color: #4ade80; }
        .btn-round.remove { border-color: #7f1d1d; color: #f87171; }
        .btn-del {
            background: none;
            border: none;
            color: #444;
            cursor: pointer;
            font-size: 14px;
            padding: 4px;
        }
        .btn-del:hover { color: #ef4444; }

        /* Batches */
        .batch-list {
            margin-top: 6px;
            padding-left: 8px;
            border-left: 2px solid #222;
        }
        .batch-row {
            font-size: 12px;
            color: #555;
            padding: 2px 0;
            display: flex;
            gap: 8px;
        }
        .batch-row .batch-qty { color: #888; font-weight: 600; min-width: 40px; }
        .batch-row .expiry-ok { color: #555; }
        .batch-row .expiry-soon { color: #f59e0b; }
        .batch-row .expiry-expired { color: #ef4444; }

        .empty-state { color: #444; font-size: 14px; padding: 12px 0; text-align: center; }

        /* Management panel */
        .panel-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: #0f0f0f;
            z-index: 100;
            overflow-y: auto;
        }
        .panel-overlay.active { display: block; }
        .panel {
            max-width: 800px;
            margin: 0 auto;
            padding: 16px;
        }
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #222;
            margin-bottom: 16px;
        }
        .panel-header h2 { font-size: 18px; color: #fff; font-weight: 600; }
        .panel-header-btns { display: flex; gap: 8px; }
        .panel-close {
            background: none;
            border: 1px solid #333;
            color: #aaa;
            font-size: 14px;
            padding: 6px 14px;
            border-radius: 6px;
            cursor: pointer;
        }
        .panel-close:active { opacity: 0.7; }
        .btn-save-all {
            background: #166534;
            border: none;
            color: #4ade80;
            font-size: 14px;
            font-weight: 600;
            padding: 6px 14px;
            border-radius: 6px;
            cursor: pointer;
        }
        .btn-save-all:active { opacity: 0.7; }
        .btn-save-all:disabled { background: #1a1a1a; color: #444; cursor: default; }

        /* Changes summary */
        .changes-summary {
            background: #1a2e1a;
            border: 1px solid #2d4a2d;
            border-radius: 8px;
            padding: 12px 14px;
            margin-bottom: 14px;
        }
        .changes-summary.has-deletes { background: #2e1a1a; border-color: #4a2d2d; }
        .changes-title { font-size: 13px; color: #4ade80; font-weight: 600; margin-bottom: 6px; }
        .changes-summary.has-deletes .changes-title { color: #f59e0b; }
        .change-item { font-size: 12px; color: #aaa; padding: 2px 0; }
        .change-item .change-type { font-weight: 600; }
        .change-item .change-type.edit { color: #60a5fa; }
        .change-item .change-type.delete { color: #f87171; }

        /* Edit cards */
        .edit-card {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 10px;
            transition: border-color 0.2s;
        }
        .edit-card.modified { border-color: #2563eb; }
        .edit-card.to-delete { border-color: #991b1b; opacity: 0.5; }
        .edit-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .edit-card-header .name { font-size: 16px; font-weight: 600; color: #fff; }
        .edit-card-header .barcode { font-size: 12px; color: #555; }
        .edit-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        .edit-grid .form-group input,
        .edit-grid .form-group select {
            padding: 6px 8px;
            font-size: 13px;
        }
        .edit-grid .form-group label { font-size: 11px; }
        .edit-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .btn-delete-sm {
            background: #7f1d1d;
            color: #f87171;
            padding: 6px 14px;
            font-size: 13px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .btn-undo-sm {
            background: #333;
            color: #aaa;
            padding: 6px 14px;
            font-size: 13px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .edit-batch-list {
            margin-top: 8px;
            padding-left: 8px;
            border-left: 2px solid #222;
        }
        .edit-batch-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            font-size: 12px;
            color: #888;
        }
        .edit-batch-row .batch-qty-label { min-width: 40px; font-weight: 600; }
        .edit-batch-row input[type="date"] {
            background: #111;
            border: 1px solid #333;
            color: #fff;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 12px;
        }
        .edit-batch-row input[type="date"]:focus { outline: none; border-color: #555; }
        .edit-batch-row.batch-modified input[type="date"] { border-color: #2563eb; }
        .btn-manage {
            background: none;
            border: 1px solid #333;
            color: #888;
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .btn-manage:active { opacity: 0.7; }

        /* Existing product view */
        .existing-header {
            background: #1a2e1a;
            border: 1px solid #2d4a2d;
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 10px;
        }
        .existing-header #existing-product-name { color: #4ade80; font-weight: 600; font-size: 15px; }
        .existing-header #existing-product-stock { color: #888; font-size: 13px; margin-left: 8px; }
        .existing-batch-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            border-bottom: 1px solid #222;
            font-size: 14px;
        }
        .existing-batch-row:last-child { border-bottom: none; }
        .existing-batch-row .eb-info { flex: 1; min-width: 0; }
        .existing-batch-row .eb-qty { color: #fff; font-weight: 600; min-width: 40px; }
        .existing-batch-row .eb-expiry { color: #888; font-size: 13px; }
        .new-batch-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 0;
            margin-top: 4px;
            border-top: 1px solid #333;
        }
        .new-batch-label { color: #666; font-size: 13px; font-weight: 600; }
        .new-batch-row input[type="date"],
        .new-batch-row input[type="number"] {
            background: #111;
            border: 1px solid #333;
            color: #fff;
            padding: 6px 8px;
            border-radius: 6px;
            font-size: 13px;
        }
        .new-batch-row input[type="date"]:focus,
        .new-batch-row input[type="number"]:focus { outline: none; border-color: #555; }

        /* Search results */
        .search-results {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            margin-top: 6px;
            overflow: hidden;
        }
        .search-result-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #222;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:active { background: #252525; }
        .search-result-item .sr-name { color: #e0e0e0; font-size: 14px; }
        .search-result-item .sr-meta { color: #555; font-size: 12px; }
        .search-no-results { padding: 10px 12px; color: #555; font-size: 13px; }

        /* Ticket scanner */
        .ticket-progress {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 6px;
            padding: 12px;
            margin-top: 10px;
            text-align: center;
        }
        .ticket-progress .tp-text { color: #888; font-size: 13px; margin-bottom: 8px; }
        .ticket-progress .tp-bar {
            height: 4px;
            background: #222;
            border-radius: 2px;
            overflow: hidden;
        }
        .ticket-progress .tp-fill {
            height: 100%;
            background: #4ade80;
            border-radius: 2px;
            transition: width 0.3s;
        }

        /* Ticket results panel */
        .ticket-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: #0f0f0f;
            z-index: 100;
            overflow-y: auto;
        }
        .ticket-overlay.active { display: block; }
        .ticket-panel {
            max-width: 800px;
            margin: 0 auto;
            padding: 16px;
        }
        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #222;
            margin-bottom: 16px;
        }
        .ticket-header h2 { font-size: 18px; color: #fff; font-weight: 600; }
        .ticket-section-title {
            font-size: 13px;
            color: #4ade80;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 0;
            margin-top: 8px;
        }
        .ticket-section-title.unmatched { color: #f59e0b; }
        .ticket-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid #222;
        }
        .ticket-item:last-child { border-bottom: none; }
        .ticket-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #4ade80;
            flex-shrink: 0;
        }
        .ticket-item .ti-info { flex: 1; min-width: 0; }
        .ticket-item .ti-line { font-size: 13px; color: #888; }
        .ticket-item .ti-match { font-size: 14px; color: #e0e0e0; font-weight: 500; }
        .ticket-item .ti-qty {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
        }
        .ticket-item .ti-qty input {
            width: 45px;
            background: #111;
            border: 1px solid #333;
            color: #fff;
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 13px;
            text-align: center;
        }
        .ticket-item .ti-qty label { font-size: 11px; color: #666; }
        .ticket-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #222;
        }
        .ticket-actions .btn { flex: 1; }

        .hidden { display: none; }

        /* Location filter */
        .location-filter-container {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }
        .location-filter-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .location-filter-select {
            flex: 1;
            min-width: 150px;
            background: #111;
            border: 1px solid #333;
            color: #fff;
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 14px;
        }
        .location-filter-select:focus { outline: none; border-color: #555; }
        .location-filter-select option { background: #1a1a1a; }

        @media (max-width: 500px) {
            .form-grid { grid-template-columns: 1fr; }
            .form-grid .full { grid-column: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Stock Manager</h1>
            <small>v0.3.4</small>
        </div>

        <!-- Stats -->
        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="total-products">0</div>
                <div class="stat-label">Productos</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="total-items">0</div>
                <div class="stat-label">Unidades</div>
            </div>
            <div class="stat warning">
                <div class="stat-value" id="low-stock-count">0</div>
                <div class="stat-label">Faltan</div>
            </div>
        </div>

        <!-- Necesitas comprar -->
        <div class="section" id="shopping-section">
            <div class="section-header" onclick="toggleSection('shopping-section')">
                <h2>Lista de la compra</h2>
                <span class="toggle"></span>
            </div>
            <div class="section-body">
                <div id="shopping-list"></div>
            </div>
        </div>

        <!-- Escanear / Añadir -->
        <div class="section" id="scanner-section">
            <div class="section-header" onclick="toggleSection('scanner-section')">
                <h2>Escanear / Añadir</h2>
                <span class="toggle"></span>
            </div>
            <div class="section-body">
                <div class="barcode-input">
                    <input type="text" id="manual-barcode" placeholder="Código de barras o nombre" autocomplete="off">
                    <button class="btn btn-primary" onclick="useManualBarcode()">Buscar</button>
                </div>
                <div id="search-results" class="search-results hidden"></div>
                <div class="camera-row">
                    <button class="btn btn-primary" id="start-scan" style="flex:1">Escanear código</button>
                    <button class="btn btn-primary" id="start-ticket" style="flex:1">Leer ticket</button>
                    <button class="btn btn-remove hidden" id="stop-scan" style="flex:1">Detener</button>
                </div>
                <div id="scanner-container"></div>
                <div id="ticket-progress" class="ticket-progress hidden">
                    <div class="tp-text" id="ticket-status">Preparando cámara...</div>
                    <div class="tp-bar"><div class="tp-fill" id="ticket-fill" style="width:0%"></div></div>
                </div>
                <div id="scanned-code" class="hidden"></div>

                <div id="product-action" class="hidden">
                    <!-- Existing product: batch-level controls -->
                    <div id="existing-product-view" class="hidden">
                        <div class="existing-header">
                            <span id="existing-product-name"></span>
                            <span id="existing-product-stock"></span>
                        </div>
                        <div id="existing-batches"></div>
                        <div class="new-batch-row">
                            <span class="new-batch-label">Nuevo lote</span>
                            <input type="date" id="new-batch-expiry">
                            <input type="number" id="new-batch-qty" value="1" min="1" style="width:50px;">
                            <button class="btn-round add" onclick="addNewBatch()">+</button>
                        </div>
                    </div>
                    <!-- New product: full form -->
                    <div id="new-product-fields">
                        <div class="form-grid">
                            <div class="form-group full">
                                <label>Nombre</label>
                                <input type="text" id="product-name" placeholder="Ej: Leche Entera">
                            </div>
                            <div class="form-group">
                                <label>Categoría</label>
                                <select id="product-category">
                                    <option value="Alimentos">Alimentos</option>
                                    <option value="Bebidas">Bebidas</option>
                                    <option value="Limpieza">Limpieza</option>
                                    <option value="Higiene">Higiene Personal</option>
                                    <option value="Otros">Otros</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Ubicación</label>
                                <input type="text" id="product-location" placeholder="Ej: Despensa, Nevera">
                            </div>
                            <div class="form-group">
                                <label>Stock Mínimo</label>
                                <input type="number" id="min-stock" value="2" min="1">
                            </div>
                            <div class="form-group">
                                <label>Caducidad</label>
                                <input type="date" id="expiry-date">
                            </div>
                            <div class="form-group">
                                <label>Cantidad</label>
                                <input type="number" id="quantity" value="1" min="1">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-add" onclick="addStock()">Añadir</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventario -->
        <div class="section" id="inventory-section">
            <div class="section-header">
                <h2 onclick="toggleSection('inventory-section')" style="flex:1">Inventario</h2>
                <button class="btn-manage" onclick="event.stopPropagation(); openManagePanel()">Gestionar</button>
                <span class="toggle" onclick="toggleSection('inventory-section')" style="margin-left:8px"></span>
            </div>
            <div class="section-body">
                <div id="location-filter" style="margin-bottom:12px;"></div>
                <div id="product-list"></div>
            </div>
        </div>
    </div>

    <!-- Panel de gestión -->
    <div class="panel-overlay" id="manage-panel">
        <div class="panel">
            <div class="panel-header">
                <h2>Gestionar Inventario</h2>
                <div class="panel-header-btns">
                    <button class="btn-save-all" id="btn-save-all" disabled onclick="saveAllChanges()">Guardar todo</button>
                    <button class="panel-close" onclick="tryClosePanel()">Volver</button>
                </div>
            </div>
            <div id="changes-container" class="hidden"></div>
            <!-- Filters -->
            <div style="background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                <div style="font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px;">Filtros</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                    <div class="form-group">
                        <label>Buscar por nombre</label>
                        <input type="text" id="manage-filter-name" placeholder="Nombre..." oninput="updateManageFilter()">
                    </div>
                    <div class="form-group">
                        <label>Ubicación</label>
                        <select id="manage-filter-location" onchange="updateManageFilter()">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Categoría</label>
                        <select id="manage-filter-category" onchange="updateManageFilter()">
                            <option value="">Todas</option>
                            <option value="Alimentos">Alimentos</option>
                            <option value="Bebidas">Bebidas</option>
                            <option value="Limpieza">Limpieza</option>
                            <option value="Higiene">Higiene Personal</option>
                            <option value="Otros">Otros</option>
                        </select>
                    </div>
                </div>
            </div>
            <div id="manage-list"></div>
        </div>
    </div>

    <!-- Panel de resultados del ticket -->
    <div class="ticket-overlay" id="ticket-panel">
        <div class="ticket-panel">
            <div class="ticket-header">
                <h2>Ticket escaneado</h2>
                <button class="panel-close" onclick="closeTicketPanel()">Cancelar</button>
            </div>
            <div id="ticket-matched"></div>
            <div id="ticket-unmatched"></div>
            <div class="ticket-actions">
                <button class="btn btn-add" onclick="confirmTicketItems()">Añadir seleccionados</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = `${window.location.pathname.replace(/\/$/, '')}/api`;
        let html5QrCode;
        let products = [];
        let currentBarcode = null;
        let ticketItems = [];
        let filteredLocation = null;
        let allLocations = [];

        window.onload = async function() {
            await loadProducts();
        };

        function toggleSection(id) {
            document.getElementById(id).classList.toggle('collapsed');
        }

        // API
        async function apiCall(endpoint, method = 'GET', body = null) {
            const options = { method, headers: { 'Content-Type': 'application/json' } };
            if (body) options.body = JSON.stringify(body);
            const url = `${API_BASE}${endpoint}`;
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    const text = await response.text().catch(() => '');
                    let msg;
                    try { msg = JSON.parse(text).detail || `Error ${response.status}`; }
                    catch { msg = `Error ${response.status}: ${text.substring(0, 200) || response.statusText}`; }
                    throw new Error(msg);
                }
                if (method === 'DELETE') return true;
                return await response.json().catch(() => { throw new Error('Respuesta inválida'); });
            } catch (error) {
                console.error(`API Error [${method} ${url}]:`, error);
                alert(error.message);
                throw error;
            }
        }

        async function loadProducts() {
            try {
                products = await apiCall('/products');
                updateUI();
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        async function loadStats() {
            try { return await apiCall('/stats'); }
            catch { return { total_products: 0, total_units: 0, low_stock_count: 0 }; }
        }

        // Scanner
        document.getElementById('start-scan').onclick = async function() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Cámara no disponible. Se requiere HTTPS.');
                }
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                stream.getTracks().forEach(track => track.stop());
                html5QrCode = new Html5Qrcode("scanner-container");
                await html5QrCode.start(
                    { facingMode: "environment" },
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    onScanSuccess
                );
                document.getElementById('start-scan').classList.add('hidden');
                document.getElementById('start-ticket').classList.add('hidden');
                document.getElementById('stop-scan').classList.remove('hidden');
            } catch (err) {
                alert('Error cámara: ' + err.message);
            }
        };

        document.getElementById('stop-scan').onclick = function() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('start-scan').classList.remove('hidden');
                    document.getElementById('start-ticket').classList.remove('hidden');
                    document.getElementById('stop-scan').classList.add('hidden');
                });
            }
        };

        // Ticket scanner
        document.getElementById('start-ticket').onclick = async function() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Cámara no disponible. Se requiere HTTPS.');
                }
                // Open camera, take a photo, then run OCR
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } }
                });
                // Create video element to capture frame
                const video = document.createElement('video');
                video.srcObject = stream;
                video.setAttribute('playsinline', 'true');
                await video.play();

                // Show video preview in scanner container
                const container = document.getElementById('scanner-container');
                container.innerHTML = '';
                video.style.width = '100%';
                video.style.borderRadius = '8px';
                container.appendChild(video);

                // Add capture button
                const captureBtn = document.createElement('button');
                captureBtn.className = 'btn btn-add';
                captureBtn.style.cssText = 'width:100%;margin-top:8px;';
                captureBtn.textContent = 'Capturar ticket';
                container.appendChild(captureBtn);

                document.getElementById('start-scan').classList.add('hidden');
                document.getElementById('start-ticket').classList.add('hidden');
                document.getElementById('stop-scan').classList.remove('hidden');

                captureBtn.onclick = async function() {
                    // Capture frame to canvas
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    canvas.getContext('2d').drawImage(video, 0, 0);

                    // Stop camera
                    stream.getTracks().forEach(t => t.stop());
                    container.innerHTML = '';
                    document.getElementById('start-scan').classList.remove('hidden');
                    document.getElementById('start-ticket').classList.remove('hidden');
                    document.getElementById('stop-scan').classList.add('hidden');

                    // Run OCR
                    await processTicketImage(canvas);
                };

                // Override stop button to clean up
                const origStop = document.getElementById('stop-scan').onclick;
                document.getElementById('stop-scan').onclick = function() {
                    stream.getTracks().forEach(t => t.stop());
                    container.innerHTML = '';
                    document.getElementById('start-scan').classList.remove('hidden');
                    document.getElementById('start-ticket').classList.remove('hidden');
                    document.getElementById('stop-scan').classList.add('hidden');
                    document.getElementById('stop-scan').onclick = origStop;
                };
            } catch (err) {
                alert('Error cámara: ' + err.message);
            }
        };

        async function processTicketImage(canvas) {
            const progress = document.getElementById('ticket-progress');
            const statusEl = document.getElementById('ticket-status');
            const fillEl = document.getElementById('ticket-fill');
            progress.classList.remove('hidden');
            statusEl.textContent = 'Preparando imagen...';
            fillEl.style.width = '5%';

            // Preprocess: grayscale + high contrast + threshold for better OCR
            const ctx = canvas.getContext('2d');
            const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imgData.data;
            for (let i = 0; i < data.length; i += 4) {
                // Grayscale
                const gray = data[i] * 0.299 + data[i+1] * 0.587 + data[i+2] * 0.114;
                // Increase contrast
                const contrast = ((gray / 255 - 0.5) * 1.8 + 0.5) * 255;
                // Threshold to B&W
                const bw = contrast > 140 ? 255 : 0;
                data[i] = data[i+1] = data[i+2] = bw;
            }
            ctx.putImageData(imgData, 0, 0);

            statusEl.textContent = 'Leyendo ticket...';
            fillEl.style.width = '10%';

            try {
                const result = await Tesseract.recognize(canvas, 'spa', {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const pct = Math.round(m.progress * 100);
                            fillEl.style.width = pct + '%';
                            statusEl.textContent = `Leyendo ticket... ${pct}%`;
                        }
                    }
                });

                progress.classList.add('hidden');
                const text = result.data.text;
                parseTicketText(text);
            } catch (err) {
                progress.classList.add('hidden');
                alert('Error al leer ticket: ' + err.message);
            }
        }

        function normalizeText(text) {
            return text.toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9\s]/g, '')
                .trim();
        }

        function isJunkLine(line) {
            const trimmed = line.trim();
            const norm = normalizeText(line);

            // Too short
            if (norm.length < 3) return true;

            // Only numbers, codes, symbols
            if (/^\d+$/.test(norm)) return true;
            if (/^[\d\s\-\/\.\,\*\#\:\;\(\)\[\]]+$/.test(trimmed)) return true;

            // Barcodes / EAN codes
            if (/\d{7,}/.test(trimmed)) return true;

            // Lines that are mostly numbers (>60% digits)
            const digitCount = (trimmed.match(/\d/g) || []).length;
            const letterCount = (trimmed.match(/[a-zA-ZáéíóúñÁÉÍÓÚÑ]/g) || []).length;
            if (letterCount < 2) return true;
            if (digitCount > 0 && letterCount > 0 && digitCount / (digitCount + letterCount) > 0.6) return true;

            // Common receipt noise — check anywhere in line, not just start
            const junkAnywhere = [
                /\btotal\b/i, /\bsubtotal\b/i, /\biva\b/i, /\bbase\s*imp/i,
                /\bcambio\b/i, /\befectivo\b/i, /\btarjeta\b/i, /\bvisa\b/i, /\bmastercard\b/i,
                /\bnif\b/i, /\bcif\b/i, /\bn\.i\.f/i, /\bc\.i\.f/i,
                /\bgracias\b/i, /\bticket\b/i, /\bfactura\b/i, /\brecibo\b/i,
                /\bdescuento\b/i, /\bahorro\b/i, /\bdto\b/i,
                /\bredondeo\b/i, /\bsaldo\b/i, /\bpuntos\b/i, /\bcup[oó]n\b/i,
                /\bdevoluci[oó]n\b/i, /\bpago\b/i, /\bimporte\b/i,
                /\bcliente\b/i, /\bsocio\b/i,
                /\btpv\b/i, /\boperaci[oó]n\b/i
            ];

            // Patterns that match from the start
            const junkStart = [
                /^fecha/i, /^hora/i,
                /^\d{1,2}[\/:]\d{2}/, /^\d{1,2}[\/-]\d{1,2}[\/-]\d{2,4}/,
                /^tel[eé]?f/i, /^fax/i, /^www\./i, /^http/i, /^@/,
                /^le\s+atien/i, /^caja\b/i, /^op[\.\s]/i,
                /^precio/i, /^p\.?v\.?p/i,
                /^avd?a?[\.\s]/i, /^c\//i, /^calle\s/i, /^plaza\s/i, /^pol[ií]gono/i,
                /^cp\s*\d/i, /^\d{5}\s+\w/,
                /^reg[\.\s]/i, /^inscri/i,
                /^aut[\.\s]*\d/i, /^ref[\.\s]*\d/i,
                /^art[ií]culos?\b/i, /^unidades\b/i,
                /^super\b/i, /^mercadona/i, /^carrefour/i, /^lidl/i, /^aldi/i,
                /^dia\s/i, /^eroski/i, /^alcampo/i, /^hipercor/i, /^el\s*corte/i,
                /^bonpreu/i, /^consum\b/i, /^caprabo/i, /^ahorram/i, /^hacendado/i,
                /^delaviuda/i, /^s[\.\s]*?[al]\b/i
            ];

            for (const pat of junkAnywhere) {
                if (pat.test(trimmed)) return true;
            }
            for (const pat of junkStart) {
                if (pat.test(trimmed)) return true;
            }

            return false;
        }

        function parseTicketText(text) {
            const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 1);
            ticketItems = [];

            // Any price pattern anywhere in the line
            const priceRegex = /\d+[,.]\d{2}/;

            for (const line of lines) {
                // Skip obvious junk but be more permissive
                const norm = normalizeText(line);
                if (norm.length < 2) continue;
                if (/^[\d\s\-\/\.\,\*\#\:\;\(\)\[\]]+$/.test(line.trim())) continue;

                // Must have at least some letters
                const letterCount = (line.match(/[a-zA-ZáéíóúñÁÉÍÓÚÑ]/g) || []).length;
                if (letterCount < 2) continue;

                // Check for price (main signal for product lines)
                const hasPrice = priceRegex.test(line);

                // Skip known junk keywords
                if (isJunkLine(line)) continue;

                let qty = 1;
                let name = line;

                // Extract quantity: "2 x LECHE ENTERA  1,78" or "2x LECHE"
                const qtyMatch = name.match(/^(\d+)\s*[xX×]\s+(.+)/);
                if (qtyMatch) {
                    qty = parseInt(qtyMatch[1]);
                    name = qtyMatch[2];
                }

                // Remove ALL prices
                name = name.replace(/\d+[,.]\d{2}\s*€?/g, '').trim();

                // Remove weight/unit
                name = name.replace(/\d+[,.]\d{1,3}\s*(kg|g|l|ml|cl|ud|uds)\b/gi, '').trim();

                // Remove leading article codes
                name = name.replace(/^\d{3,}\s+/, '').trim();

                // Remove stray symbols
                name = name.replace(/^[\-\*\.\,\s]+/, '').replace(/[\-\*\.\,\s]+$/, '').trim();

                if (name.length < 2) continue;

                // Match against existing products
                let bestMatch = null;
                let bestScore = 0;
                for (const p of products) {
                    const score = similarityScore(normalizeText(name), normalizeText(p.name));
                    if (score > bestScore && score >= 0.35) {
                        bestScore = score;
                        bestMatch = p;
                    }
                }

                // Merge duplicates for same matched product
                if (bestMatch) {
                    const existing = ticketItems.find(t => t.match && t.match.barcode === bestMatch.barcode);
                    if (existing) {
                        existing.qty += qty;
                        continue;
                    }
                }

                // Include ALL detected lines (with or without match)
                ticketItems.push({
                    line: line,
                    name: name,
                    qty: qty,
                    match: bestMatch,
                    score: bestScore,
                    checked: bestMatch !== null,
                    hasPrice: hasPrice
                });
            }

            showTicketResults(text);
        }

        function similarityScore(a, b) {
            // Check if one contains the other
            if (a.includes(b) || b.includes(a)) return 0.9;

            // Word overlap
            const wordsA = a.split(/\s+/).filter(w => w.length > 2);
            const wordsB = b.split(/\s+/).filter(w => w.length > 2);
            if (wordsA.length === 0 || wordsB.length === 0) return 0;

            let matches = 0;
            for (const wa of wordsA) {
                for (const wb of wordsB) {
                    if (wa.includes(wb) || wb.includes(wa)) { matches++; break; }
                }
            }
            return matches / Math.max(wordsA.length, wordsB.length);
        }

        function showTicketResults(rawText) {
            const matched = ticketItems.filter(t => t.match);
            const unmatched = ticketItems.filter(t => !t.match);

            let html = '';

            if (matched.length > 0) {
                html += '<div class="ticket-section-title">Coinciden con tu inventario</div>';
                matched.forEach(item => {
                    const idx = ticketItems.indexOf(item);
                    html += `<div class="ticket-item">
                        <input type="checkbox" id="ti-check-${idx}" checked
                            onchange="ticketItems[${idx}].checked = this.checked">
                        <div class="ti-info">
                            <div class="ti-match">${item.match.name}</div>
                            <div class="ti-line">Ticket: ${item.name}</div>
                        </div>
                        <div class="ti-qty">
                            <label>Uds</label>
                            <input type="number" value="${item.qty}" min="1"
                                onchange="ticketItems[${idx}].qty = parseInt(this.value)">
                        </div>
                    </div>`;
                });
            }

            if (unmatched.length > 0) {
                html += '<div class="ticket-section-title unmatched">Detectados en ticket (sin coincidencia)</div>';
                unmatched.forEach(item => {
                    const idx = ticketItems.indexOf(item);
                    html += `<div class="ticket-item">
                        <input type="checkbox" id="ti-check-${idx}"
                            onchange="ticketItems[${idx}].checked = this.checked">
                        <div class="ti-info">
                            <div class="ti-match" style="color:#f59e0b">${item.name}</div>
                            <div class="ti-line">${item.line}</div>
                        </div>
                        <div class="ti-qty">
                            <label>Uds</label>
                            <input type="number" value="${item.qty}" min="1"
                                onchange="ticketItems[${idx}].qty = parseInt(this.value)">
                        </div>
                    </div>`;
                });
            }

            if (ticketItems.length === 0) {
                html = '<div style="color:#555;text-align:center;padding:20px;">No se han detectado líneas de producto</div>';
            }

            // Raw OCR text for debugging
            html += `<div style="margin-top:20px;padding-top:12px;border-top:1px solid #222;">
                <div class="ticket-section-title" style="color:#555;cursor:pointer" onclick="this.nextElementSibling.classList.toggle('hidden')">
                    Texto OCR (toca para ver)
                </div>
                <pre class="hidden" style="color:#555;font-size:11px;white-space:pre-wrap;word-break:break-all;background:#111;padding:10px;border-radius:6px;margin-top:6px;max-height:300px;overflow-y:auto">${rawText || 'Sin texto'}</pre>
            </div>`;

            document.getElementById('ticket-matched').innerHTML = html;
            document.getElementById('ticket-unmatched').innerHTML = '';
            document.getElementById('ticket-panel').classList.add('active');
        }

        function closeTicketPanel() {
            document.getElementById('ticket-panel').classList.remove('active');
            ticketItems = [];
        }

        async function confirmTicketItems() {
            const selected = ticketItems.filter(t => t.checked);
            if (selected.length === 0) { alert('No hay productos seleccionados'); return; }

            let added = 0;
            let errors = 0;
            for (const item of selected) {
                try {
                    if (item.match) {
                        // Existing product: add stock to first batch
                        const p = item.match;
                        if (p.batches && p.batches.length > 0) {
                            await apiCall(`/batches/${p.batches[0].id}/stock`, 'POST', { quantity: item.qty });
                        } else {
                            await apiCall(`/products/${p.barcode}/stock`, 'POST', { quantity: item.qty });
                        }
                        added++;
                    }
                    // Unmatched items that are checked - skip for now (user would need to create them manually)
                } catch (e) {
                    errors++;
                }
            }

            await loadProducts();
            closeTicketPanel();

            if (errors > 0) {
                alert(`${added} producto${added !== 1 ? 's' : ''} añadido${added !== 1 ? 's' : ''}. ${errors} error${errors !== 1 ? 'es' : ''}.`);
            }
        }

        function useManualBarcode() {
            const input = document.getElementById('manual-barcode').value.trim();
            if (!input) { alert('Introduce un código o nombre'); return; }

            // First try exact barcode match
            const byBarcode = products.find(p => p.barcode === input);
            if (byBarcode) {
                hideSearchResults();
                onScanSuccess(input);
                document.getElementById('manual-barcode').value = '';
                return;
            }

            // Search by name (case-insensitive partial match)
            const query = input.toLowerCase();
            const matches = products.filter(p => p.name.toLowerCase().includes(query));

            if (matches.length === 1) {
                // Single match - select it directly
                hideSearchResults();
                onScanSuccess(matches[0].barcode);
                document.getElementById('manual-barcode').value = '';
            } else if (matches.length > 1) {
                // Multiple matches - show list to pick from
                showSearchResults(matches);
            } else {
                // No match - treat as new barcode
                hideSearchResults();
                onScanSuccess(input);
                document.getElementById('manual-barcode').value = '';
            }
        }

        function showSearchResults(matches) {
            const container = document.getElementById('search-results');
            container.innerHTML = matches.map(p =>
                `<div class="search-result-item" onclick="pickSearchResult('${p.barcode}')">
                    <span class="sr-name">${p.name}</span>
                    <span class="sr-meta">${p.stock} uds · ${p.category}</span>
                </div>`
            ).join('');
            container.classList.remove('hidden');
        }

        function hideSearchResults() {
            document.getElementById('search-results').classList.add('hidden');
        }

        function pickSearchResult(barcode) {
            hideSearchResults();
            onScanSuccess(barcode);
            document.getElementById('manual-barcode').value = '';
        }

        function onScanSuccess(decodedText) {
            currentBarcode = decodedText;
            document.getElementById('scanned-code').textContent = 'Código: ' + decodedText;
            document.getElementById('scanned-code').classList.remove('hidden');
            document.getElementById('product-action').classList.remove('hidden');

            const product = products.find(p => p.barcode === currentBarcode);
            if (product) {
                // Existing product: show batch-level controls
                document.getElementById('existing-product-view').classList.remove('hidden');
                document.getElementById('new-product-fields').classList.add('hidden');
                document.getElementById('existing-product-name').textContent = product.name;
                document.getElementById('existing-product-stock').textContent = `(${product.stock} uds)`;
                renderExistingBatches(product);
            } else {
                // New product: show full form
                document.getElementById('existing-product-view').classList.add('hidden');
                document.getElementById('new-product-fields').classList.remove('hidden');
                document.getElementById('product-name').value = '';
                document.getElementById('product-location').value = '';
                document.getElementById('min-stock').value = 2;
                document.getElementById('expiry-date').value = '';
                document.getElementById('quantity').value = 1;
            }

            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    document.getElementById('start-scan').classList.remove('hidden');
                    document.getElementById('start-ticket').classList.remove('hidden');
                    document.getElementById('stop-scan').classList.add('hidden');
                });
            }
        }

        function renderExistingBatches(product) {
            const container = document.getElementById('existing-batches');
            if (!product.batches || product.batches.length === 0) {
                container.innerHTML = '<div style="color:#555;font-size:13px;padding:6px 0;">Sin lotes</div>';
                return;
            }
            container.innerHTML = product.batches.map(b => {
                const exp = getExpiryInfo(b.expiry_date);
                const expText = exp
                    ? `<span class="${exp.cls}">${exp.text}</span>`
                    : '<span style="color:#555">Sin caducidad</span>';
                return `<div class="existing-batch-row">
                    <div class="eb-info">
                        <span class="eb-qty">${b.quantity} ud${b.quantity > 1 ? 's' : ''}</span>
                        <span class="eb-expiry">${expText}</span>
                    </div>
                    <button class="btn-round remove" onclick="batchRemove(${b.id})">-</button>
                    <button class="btn-round add" onclick="batchAdd(${b.id})">+</button>
                </div>`;
            }).join('');
        }

        async function batchAdd(batchId) {
            try {
                const product = products.find(p => p.barcode === currentBarcode);
                // If product has no batches, ask for expiry date
                if (!product || !product.batches || product.batches.length === 0) {
                    const expiryDate = prompt('Introduce la fecha de caducidad (YYYY-MM-DD) o deja vacío si no tiene:');
                    if (expiryDate !== null) {
                        await apiCall(`/products/${currentBarcode}/stock`, 'POST', { quantity: 1, expiry_date: expiryDate || null });
                    }
                } else {
                    await apiCall(`/batches/${batchId}/stock`, 'POST', { quantity: 1 });
                }
                await loadProducts();
                // Re-render the existing product view
                const updatedProduct = products.find(p => p.barcode === currentBarcode);
                if (updatedProduct) {
                    document.getElementById('existing-product-stock').textContent = `(${updatedProduct.stock} uds)`;
                    renderExistingBatches(updatedProduct);
                }
            } catch (e) { console.error('Error:', e); }
        }

        async function batchRemove(batchId) {
            try {
                const product = products.find(p => p.barcode === currentBarcode);
                // If product has no batches, ask for expiry date
                if (!product || !product.batches || product.batches.length === 0) {
                    const expiryDate = prompt('Introduce la fecha de caducidad (YYYY-MM-DD) o deja vacío si no tiene:');
                    if (expiryDate !== null) {
                        // Create a batch first, then remove from it
                        await apiCall(`/products/${currentBarcode}/stock`, 'POST', { quantity: 1, expiry_date: expiryDate || null });
                        await loadProducts();
                        const updatedProduct = products.find(p => p.barcode === currentBarcode);
                        if (updatedProduct && updatedProduct.batches && updatedProduct.batches.length > 0) {
                            await apiCall(`/batches/${updatedProduct.batches[0].id}/stock`, 'POST', { quantity: -1 });
                        }
                    }
                } else {
                    await apiCall(`/batches/${batchId}/stock`, 'POST', { quantity: -1 });
                }
                await loadProducts();
                const updatedProduct = products.find(p => p.barcode === currentBarcode);
                if (updatedProduct) {
                    document.getElementById('existing-product-stock').textContent = `(${updatedProduct.stock} uds)`;
                    renderExistingBatches(updatedProduct);
                }
            } catch (e) { console.error('Error:', e); }
        }

        async function addNewBatch() {
            if (!currentBarcode) return;
            const expiryDate = document.getElementById('new-batch-expiry').value || null;
            const quantity = parseInt(document.getElementById('new-batch-qty').value) || 1;
            try {
                await apiCall(`/products/${currentBarcode}/stock`, 'POST', {
                    quantity, expiry_date: expiryDate
                });
                await loadProducts();
                const product = products.find(p => p.barcode === currentBarcode);
                if (product) {
                    document.getElementById('existing-product-stock').textContent = `(${product.stock} uds)`;
                    renderExistingBatches(product);
                }
                document.getElementById('new-batch-expiry').value = '';
                document.getElementById('new-batch-qty').value = 1;
            } catch (e) { console.error('Error:', e); }
        }

        async function addStock() {
            if (!currentBarcode) return;
            const name = document.getElementById('product-name').value.trim();
            const category = document.getElementById('product-category').value;
            const location = document.getElementById('product-location').value.trim() || null;
            const minStock = parseInt(document.getElementById('min-stock').value);
            const expiryDate = document.getElementById('expiry-date').value || null;
            const quantity = parseInt(document.getElementById('quantity').value);
            if (!name) { alert('Introduce el nombre del producto'); return; }
            try {
                const product = products.find(p => p.barcode === currentBarcode);
                if (!product) {
                    await apiCall('/products', 'POST', {
                        barcode: currentBarcode, name, category, min_stock: minStock, location
                    });
                }
                await apiCall(`/products/${currentBarcode}/stock`, 'POST', {
                    quantity, expiry_date: expiryDate
                });
                await loadProducts();
                resetScanner();
            } catch (error) {
                console.error('Error adding stock:', error);
            }
        }


        function resetScanner() {
            currentBarcode = null;
            document.getElementById('scanned-code').classList.add('hidden');
            document.getElementById('product-action').classList.add('hidden');
            document.getElementById('existing-product-view').classList.add('hidden');
            document.getElementById('new-product-fields').classList.add('hidden');
        }

        async function deleteProduct(barcode) {
            if (confirm('¿Eliminar este producto?')) {
                try {
                    await apiCall(`/products/${barcode}`, 'DELETE');
                    await loadProducts();
                } catch (error) {
                    console.error('Error deleting product:', error);
                }
            }
        }

        async function quickAdd(barcode) {
            try {
                const product = products.find(p => p.barcode === barcode);
                if (product && product.batches && product.batches.length > 0) {
                    // Add to first batch (earliest expiry)
                    await apiCall(`/batches/${product.batches[0].id}/stock`, 'POST', { quantity: 1 });
                } else {
                    // No batches yet, create one
                    await apiCall(`/products/${barcode}/stock`, 'POST', { quantity: 1 });
                }
                await loadProducts();
            } catch (error) { console.error('Error:', error); }
        }

        async function quickRemove(barcode) {
            const product = products.find(p => p.barcode === barcode);
            if (product && product.stock > 0 && product.batches && product.batches.length > 0) {
                try {
                    // Remove from first batch (earliest expiry - FIFO)
                    await apiCall(`/batches/${product.batches[0].id}/stock`, 'POST', { quantity: -1 });
                    await loadProducts();
                } catch (error) { console.error('Error:', error); }
            }
        }

        // UI
        async function updateUI() {
            const stats = await loadStats();
            document.getElementById('total-products').textContent = stats.total_products;
            document.getElementById('total-items').textContent = stats.total_units;
            document.getElementById('low-stock-count').textContent = stats.low_stock_count;
            await loadLocations();
            updateShoppingList();
            updateProductList();
        }

        function getExpiryInfo(expiryDate) {
            if (!expiryDate) return null;
            const today = new Date(); today.setHours(0,0,0,0);
            const expiry = new Date(expiryDate + 'T00:00:00');
            const daysLeft = Math.ceil((expiry - today) / 86400000);
            if (daysLeft < 0) return { text: 'CADUCADO', cls: 'expiry-expired' };
            if (daysLeft === 0) return { text: 'Caduca HOY', cls: 'expiry-expired' };
            if (daysLeft <= 7) return { text: `Caduca en ${daysLeft}d`, cls: 'expiry-soon' };
            return { text: `Cad: ${expiry.toLocaleDateString('es-ES')}`, cls: 'expiry-ok' };
        }

        function updateShoppingList() {
            const list = document.getElementById('shopping-list');
            const lowStock = products.filter(p => p.stock < p.min_stock);

            if (lowStock.length === 0) {
                list.innerHTML = '<div class="shopping-empty">Todo en orden</div>';
                return;
            }

            list.innerHTML = lowStock.map(p => {
                const needed = p.min_stock - p.stock;
                const exp = getExpiryInfo(p.expiry_date);
                const expiryHtml = exp && (exp.cls !== 'expiry-ok')
                    ? ` <span class="expiry-warn">${exp.text}</span>` : '';
                return `<div class="shopping-item">
                    <span class="name">${p.name}${expiryHtml}</span>
                    <span class="qty">${needed} uds</span>
                </div>`;
            }).join('');
        }

        function updateProductList() {
            const list = document.getElementById('product-list');
            let filteredProducts = products;

            // Apply location filter
            if (filteredLocation) {
                filteredProducts = products.filter(p => p.location === filteredLocation);
            }

            if (filteredProducts.length === 0) {
                list.innerHTML = '<div class="empty-state">Sin productos' + (filteredLocation ? ' en ' + filteredLocation : '') + '. Escanea para empezar.</div>';
                return;
            }

            filteredProducts.sort((a, b) => {
                const aLow = a.stock < a.min_stock;
                const bLow = b.stock < b.min_stock;
                if (aLow && !bLow) return -1;
                if (!aLow && bLow) return 1;
                return a.name.localeCompare(b.name);
            });

            list.innerHTML = filteredProducts.map(p => {
                const isLow = p.stock < p.min_stock;
                // Batch breakdown
                let batchHtml = '';
                if (p.batches && p.batches.length > 0) {
                    const batchRows = p.batches.map(b => {
                        const exp = getExpiryInfo(b.expiry_date);
                        const expText = exp
                            ? `<span class="${exp.cls}">${exp.text}</span>`
                            : '<span class="expiry-ok">Sin caducidad</span>';
                        return `<div class="batch-row">
                            <span class="batch-qty">${b.quantity} ud${b.quantity > 1 ? 's' : ''}</span>
                            ${expText}
                        </div>`;
                    }).join('');
                    batchHtml = `<div class="batch-list">${batchRows}</div>`;
                }
                return `<div class="product-row">
                    <div class="product-top">
                        <div class="product-main">
                            <div class="name">${p.name}</div>
                            <div class="meta">${p.category}${p.location ? ' • ' + p.location : ''}</div>
                        </div>
                        <div class="product-stock">
                            <button class="btn-round remove" onclick="quickRemove('${p.barcode}')">-</button>
                            <span class="stock-num ${isLow ? 'low' : ''}">${p.stock}</span>
                            <button class="btn-round add" onclick="quickAdd('${p.barcode}')">+</button>
                            <button class="btn-del" onclick="deleteProduct('${p.barcode}')" title="Eliminar">&#x2715;</button>
                        </div>
                    </div>
                    ${batchHtml}
                </div>`;
            }).join('');
        }

        async function loadLocations() {
            try {
                allLocations = await apiCall('/locations');
                updateLocationFilter();
            } catch (error) {
                console.error('Error loading locations:', error);
                allLocations = [];
            }
        }

        function updateLocationFilter() {
            const filterContainer = document.getElementById('location-filter');

            if (allLocations.length === 0) {
                filterContainer.innerHTML = '';
                return;
            }

            let html = `<div class="location-filter-container">
                <span class="location-filter-label">Filtrar por ubicación:</span>
                <select class="location-filter-select" onchange="setLocationFilter(this.value)">
                    <option value="">Todas las ubicaciones</option>`;

            allLocations.forEach(loc => {
                const count = products.filter(p => p.location === loc).length;
                html += `<option value="${loc}" ${filteredLocation === loc ? 'selected' : ''}>${loc} (${count})</option>`;
            });

            html += `</select></div>`;
            filterContainer.innerHTML = html;
        }

        function setLocationFilter(location) {
            filteredLocation = location || null;
            updateProductList();
        }

        // Batch management in manage panel
        async function manageBatchStock(batchId, barcode, qty) {
            try {
                await apiCall(`/batches/${batchId}/stock`, 'POST', { quantity: qty });
                await loadProducts();
                const product = products.find(p => p.barcode === barcode);
                if (product) {
                    originalBatchData[batchId] = product.batches.find(b => b.id === batchId)?.expiry_date || '';
                }
                renderManageList();
            } catch (e) { console.error('Error:', e); }
        }

        async function addBatchInManage(barcode) {
            const dateInput = document.getElementById(`new-batch-date-${barcode}`);
            const qtyInput = document.getElementById(`new-batch-qty-${barcode}`);

            const expiryDate = dateInput.value || null;
            const quantity = parseInt(qtyInput.value) || 1;

            if (quantity <= 0) {
                alert('La cantidad debe ser mayor a 0');
                return;
            }

            try {
                await apiCall(`/products/${barcode}/stock`, 'POST', {
                    quantity: quantity,
                    expiry_date: expiryDate
                });
                await loadProducts();
                dateInput.value = '';
                qtyInput.value = 1;
                renderManageList();
            } catch (e) { console.error('Error:', e); }
        }

        // Management panel
        let pendingChanges = {};  // barcode -> { type: 'edit'|'delete', ... }
        let pendingBatchChanges = {}; // batchId -> { barcode, origExpiry, newExpiry, productName }
        let originalData = {};    // barcode -> { name, category, min_stock }
        let originalBatchData = {}; // batchId -> expiry_date

        function openManagePanel() {
            pendingChanges = {};
            pendingBatchChanges = {};
            originalData = {};
            originalBatchData = {};
            manageFilter = { name: '', location: '', category: '' };

            products.forEach(p => {
                originalData[p.barcode] = { name: p.name, category: p.category, min_stock: p.min_stock, location: p.location || '' };
                if (p.batches) {
                    p.batches.forEach(b => {
                        originalBatchData[b.id] = b.expiry_date || '';
                    });
                }
            });

            // Populate filter dropdowns
            const locSelect = document.getElementById('manage-filter-location');
            const uniqueLocations = [...new Set(products.map(p => p.location).filter(l => l))];
            locSelect.innerHTML = '<option value="">Todas</option>' +
                uniqueLocations.map(loc => `<option value="${loc}">${loc}</option>`).join('');

            document.getElementById('manage-filter-name').value = '';
            document.getElementById('manage-filter-category').value = '';

            document.getElementById('manage-panel').classList.add('active');
            renderManageList();
            updateChangesUI();
        }

        function tryClosePanel() {
            const prodCount = Object.keys(pendingChanges).length;
            const batchCount = Object.keys(pendingBatchChanges).length;
            const total = prodCount + batchCount;
            if (total > 0) {
                const lines = [];
                Object.values(pendingChanges).forEach(c => {
                    lines.push(c.type === 'delete' ? `  - Eliminar: ${c.name}` : `  - Editar: ${c.name}`);
                });
                Object.values(pendingBatchChanges).forEach(c => {
                    const from = c.origExpiry || 'sin fecha';
                    const to = c.newExpiry || 'sin fecha';
                    lines.push(`  - Lote de ${c.productName}: ${from} → ${to}`);
                });
                if (!confirm(`Tienes ${total} cambio${total > 1 ? 's' : ''} sin guardar:\n\n${lines.join('\n')}\n\n¿Salir sin guardar?`)) {
                    return;
                }
            }
            document.getElementById('manage-panel').classList.remove('active');
            loadProducts();
        }

        function checkBatchChange(batchId, barcode) {
            const input = document.getElementById(`edit-batch-${batchId}`);
            const newVal = input.value || '';
            const origVal = originalBatchData[batchId] || '';
            const p = products.find(p => p.barcode === barcode);
            const row = input.closest('.edit-batch-row');

            if (newVal !== origVal) {
                pendingBatchChanges[batchId] = {
                    barcode,
                    origExpiry: origVal,
                    newExpiry: newVal,
                    productName: p ? p.name : barcode
                };
                row.classList.add('batch-modified');
            } else {
                delete pendingBatchChanges[batchId];
                row.classList.remove('batch-modified');
            }
            updateChangesUI();
        }

        function checkProductChanges(barcode) {
            const orig = originalData[barcode];
            if (!orig) return;
            // If marked for delete, don't track edits
            if (pendingChanges[barcode] && pendingChanges[barcode].type === 'delete') return;

            const name = document.getElementById(`edit-name-${barcode}`).value.trim();
            const category = document.getElementById(`edit-cat-${barcode}`).value;
            const location = document.getElementById(`edit-location-${barcode}`).value.trim();
            const minStock = parseInt(document.getElementById(`edit-min-${barcode}`).value);

            const changes = [];
            if (name !== orig.name) changes.push(`nombre: "${orig.name}" → "${name}"`);
            if (location !== orig.location) changes.push(`ubicación: "${orig.location || 'ninguna'}" → "${location || 'ninguna'}"`);
            if (category !== orig.category) changes.push(`categoría: ${orig.category} → ${category}`);
            if (minStock !== orig.min_stock) changes.push(`stock mín: ${orig.min_stock} → ${minStock}`);

            const card = document.getElementById(`edit-${barcode}`);
            if (changes.length > 0) {
                pendingChanges[barcode] = {
                    type: 'edit', name: name || orig.name,
                    data: { name, category, min_stock: minStock, location: location || null },
                    details: changes
                };
                card.classList.add('modified');
            } else {
                delete pendingChanges[barcode];
                card.classList.remove('modified');
            }
            updateChangesUI();
        }

        function markForDelete(barcode) {
            const orig = originalData[barcode];
            pendingChanges[barcode] = { type: 'delete', name: orig.name };
            const card = document.getElementById(`edit-${barcode}`);
            card.classList.remove('modified');
            card.classList.add('to-delete');
            updateChangesUI();
        }

        function undoDelete(barcode) {
            delete pendingChanges[barcode];
            const card = document.getElementById(`edit-${barcode}`);
            card.classList.remove('to-delete');
            checkProductChanges(barcode);
            updateChangesUI();
        }

        function updateChangesUI() {
            const container = document.getElementById('changes-container');
            const btn = document.getElementById('btn-save-all');
            const prodEntries = Object.entries(pendingChanges);
            const batchEntries = Object.entries(pendingBatchChanges);
            const total = prodEntries.length + batchEntries.length;

            if (total === 0) {
                container.classList.add('hidden');
                btn.disabled = true;
                return;
            }

            btn.disabled = false;
            const hasDeletes = prodEntries.some(([, c]) => c.type === 'delete');
            let html = `<div class="changes-summary ${hasDeletes ? 'has-deletes' : ''}">`;
            html += `<div class="changes-title">${total} cambio${total > 1 ? 's' : ''} pendiente${total > 1 ? 's' : ''}</div>`;
            prodEntries.forEach(([barcode, c]) => {
                if (c.type === 'delete') {
                    html += `<div class="change-item"><span class="change-type delete">Eliminar</span> ${c.name}</div>`;
                } else {
                    html += `<div class="change-item"><span class="change-type edit">Editar</span> ${c.name}: ${c.details.join(', ')}</div>`;
                }
            });
            batchEntries.forEach(([id, c]) => {
                const from = c.origExpiry || 'sin fecha';
                const to = c.newExpiry || 'sin fecha';
                html += `<div class="change-item"><span class="change-type edit">Lote</span> ${c.productName}: caducidad ${from} → ${to}</div>`;
            });
            html += '</div>';
            container.innerHTML = html;
            container.classList.remove('hidden');
        }

        async function saveAllChanges() {
            const prodEntries = Object.entries(pendingChanges);
            const batchEntries = Object.entries(pendingBatchChanges);
            if (prodEntries.length === 0 && batchEntries.length === 0) return;

            let errors = 0;
            for (const [barcode, change] of prodEntries) {
                try {
                    if (change.type === 'delete') {
                        await apiCall(`/products/${barcode}`, 'DELETE');
                        products = products.filter(p => p.barcode !== barcode);
                        delete originalData[barcode];
                    } else {
                        await apiCall(`/products/${barcode}`, 'PATCH', change.data);
                        const p = products.find(p => p.barcode === barcode);
                        if (p) {
                            p.name = change.data.name;
                            p.category = change.data.category;
                            p.min_stock = change.data.min_stock;
                        }
                        originalData[barcode] = { ...change.data };
                    }
                } catch (e) {
                    errors++;
                }
            }

            for (const [batchId, change] of batchEntries) {
                try {
                    const expiry = change.newExpiry || null;
                    await apiCall(`/batches/${batchId}`, 'PATCH', { expiry_date: expiry });
                    originalBatchData[batchId] = change.newExpiry;
                    // Update local batch data
                    for (const p of products) {
                        if (p.batches) {
                            const b = p.batches.find(b => b.id == batchId);
                            if (b) { b.expiry_date = expiry; break; }
                        }
                    }
                } catch (e) {
                    errors++;
                }
            }

            pendingChanges = {};
            pendingBatchChanges = {};

            if (errors > 0) {
                alert(`${errors} cambio${errors > 1 ? 's' : ''} no se pudieron guardar.`);
            }

            renderManageList();
            updateChangesUI();
        }

        let manageFilter = { name: '', location: '', category: '' };

        function updateManageFilter() {
            manageFilter.name = document.getElementById('manage-filter-name').value.toLowerCase();
            manageFilter.location = document.getElementById('manage-filter-location').value;
            manageFilter.category = document.getElementById('manage-filter-category').value;
            renderManageList();
        }

        function renderManageList() {
            const list = document.getElementById('manage-list');
            if (products.length === 0) {
                list.innerHTML = '<div class="empty-state">Sin productos.</div>';
                return;
            }

            let filtered = [...products];

            // Apply filters
            if (manageFilter.name) {
                filtered = filtered.filter(p => p.name.toLowerCase().includes(manageFilter.name));
            }
            if (manageFilter.location) {
                filtered = filtered.filter(p => p.location === manageFilter.location);
            }
            if (manageFilter.category) {
                filtered = filtered.filter(p => p.category === manageFilter.category);
            }

            const sorted = filtered.sort((a, b) => a.name.localeCompare(b.name));

            if (sorted.length === 0) {
                list.innerHTML = '<div class="empty-state">No hay productos que coincidan con los filtros.</div>';
                return;
            }

            list.innerHTML = sorted.map(p => {
                const isDelete = pendingChanges[p.barcode] && pendingChanges[p.barcode].type === 'delete';
                const isModified = pendingChanges[p.barcode] && pendingChanges[p.barcode].type === 'edit';
                const cardClass = isDelete ? 'edit-card to-delete' : isModified ? 'edit-card modified' : 'edit-card';
                return `<div class="${cardClass}" id="edit-${p.barcode}">
                    <div class="edit-card-header">
                        <span class="name">${p.name}</span>
                        <span class="barcode">${p.barcode} · ${p.stock} uds</span>
                    </div>
                    <div class="edit-grid">
                        <div class="form-group">
                            <label>Nombre</label>
                            <input type="text" id="edit-name-${p.barcode}" value="${p.name}"
                                oninput="checkProductChanges('${p.barcode}')" ${isDelete ? 'disabled' : ''}>
                        </div>
                        <div class="form-group">
                            <label>Ubicación</label>
                            <input type="text" id="edit-location-${p.barcode}" value="${p.location || ''}" placeholder="Ej: Despensa"
                                oninput="checkProductChanges('${p.barcode}')" ${isDelete ? 'disabled' : ''}>
                        </div>
                        <div class="form-group">
                            <label>Categoría</label>
                            <select id="edit-cat-${p.barcode}"
                                onchange="checkProductChanges('${p.barcode}')" ${isDelete ? 'disabled' : ''}>
                                <option value="Alimentos" ${p.category === 'Alimentos' ? 'selected' : ''}>Alimentos</option>
                                <option value="Bebidas" ${p.category === 'Bebidas' ? 'selected' : ''}>Bebidas</option>
                                <option value="Limpieza" ${p.category === 'Limpieza' ? 'selected' : ''}>Limpieza</option>
                                <option value="Higiene" ${p.category === 'Higiene' ? 'selected' : ''}>Higiene Personal</option>
                                <option value="Otros" ${p.category === 'Otros' ? 'selected' : ''}>Otros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Stock Mínimo</label>
                            <input type="number" id="edit-min-${p.barcode}" value="${p.min_stock}" min="1"
                                oninput="checkProductChanges('${p.barcode}')" ${isDelete ? 'disabled' : ''}>
                        </div>
                    </div>
                    ${p.batches && p.batches.length > 0 ? `
                    <div class="edit-batch-list">
                        <div style="font-size:12px;color:#666;margin-bottom:8px;font-weight:600;">Lotes (${p.batches.length})</div>
                        ${p.batches.map(b => {
                            const exp = getExpiryInfo(b.expiry_date);
                            const isMod = pendingBatchChanges[b.id] ? 'batch-modified' : '';
                            return `<div class="edit-batch-row ${isMod}">
                                <span class="batch-qty-label">${b.quantity} ud${b.quantity > 1 ? 's' : ''}</span>
                                <input type="date" id="edit-batch-${b.id}" value="${b.expiry_date || ''}"
                                    onchange="checkBatchChange(${b.id}, '${p.barcode}')" ${isDelete ? 'disabled' : ''}>
                                <button class="btn-round remove" style="width:24px;height:24px;font-size:12px;" onclick="manageBatchStock(${b.id}, '${p.barcode}', -1)" ${isDelete ? 'disabled' : ''}>−</button>
                                <button class="btn-round add" style="width:24px;height:24px;font-size:12px;" onclick="manageBatchStock(${b.id}, '${p.barcode}', 1)" ${isDelete ? 'disabled' : ''}>+</button>
                                <span style="font-size:11px;color:#555">${b.added_date ? 'Añadido: ' + b.added_date : ''}</span>
                            </div>`;
                        }).join('')}
                        <div style="margin-top:8px;padding-top:8px;border-top:1px solid #333;">
                            <div style="font-size:12px;color:#666;margin-bottom:6px;">Nuevo lote</div>
                            <div style="display:flex;gap:6px;align-items:center;">
                                <input type="date" id="new-batch-date-${p.barcode}" style="flex:1;background:#111;border:1px solid #333;color:#fff;padding:4px 6px;border-radius:4px;font-size:12px;">
                                <input type="number" id="new-batch-qty-${p.barcode}" value="1" min="1" style="width:50px;background:#111;border:1px solid #333;color:#fff;padding:4px 6px;border-radius:4px;font-size:12px;">
                                <button class="btn-round add" style="width:24px;height:24px;font-size:12px;" onclick="addBatchInManage('${p.barcode}')" ${isDelete ? 'disabled' : ''}>+</button>
                            </div>
                        </div>
                    </div>` : `
                    <div style="margin-top:8px;padding:8px;background:#111;border-radius:4px;border:1px solid #333;">
                        <div style="font-size:12px;color:#666;margin-bottom:8px;">Sin lotes. Crear nuevo:</div>
                        <div style="display:flex;gap:6px;align-items:center;">
                            <input type="date" id="new-batch-date-${p.barcode}" style="flex:1;background:#000;border:1px solid #333;color:#fff;padding:4px 6px;border-radius:4px;font-size:12px;">
                            <input type="number" id="new-batch-qty-${p.barcode}" value="1" min="1" style="width:50px;background:#000;border:1px solid #333;color:#fff;padding:4px 6px;border-radius:4px;font-size:12px;">
                            <button class="btn-round add" style="width:24px;height:24px;font-size:12px;" onclick="addBatchInManage('${p.barcode}')" ${isDelete ? 'disabled' : ''}>+</button>
                        </div>
                    </div>`}
                    <div class="edit-actions">
                        ${isDelete
                            ? `<button class="btn-undo-sm" onclick="undoDelete('${p.barcode}')">Deshacer</button>`
                            : `<button class="btn-delete-sm" onclick="markForDelete('${p.barcode}')">Eliminar</button>`
                        }
                    </div>
                </div>`;
            }).join('');
        }
    </script>
</body>
</html>
