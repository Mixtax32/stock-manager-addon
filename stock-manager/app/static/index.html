<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Manager</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f0f0f;
            color: #e0e0e0;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 16px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #222;
            margin-bottom: 16px;
        }
        .header h1 { font-size: 18px; color: #fff; font-weight: 600; }
        .header small { color: #555; font-size: 12px; }

        /* Stats row */
        .stats {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        .stat {
            flex: 1;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        .stat-value { font-size: 24px; font-weight: 700; color: #fff; }
        .stat-label { font-size: 11px; color: #666; text-transform: uppercase; margin-top: 2px; }
        .stat.warning .stat-value { color: #f59e0b; }

        /* Sections */
        .section {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            user-select: none;
        }
        .section-header h2 { font-size: 14px; font-weight: 600; color: #aaa; text-transform: uppercase; letter-spacing: 0.5px; }
        .section-header .toggle { color: #555; font-size: 12px; }
        .section-body { padding: 0 16px 16px; }
        .section.collapsed .section-body { display: none; }
        .section.collapsed .toggle::after { content: 'mostrar'; }
        .section:not(.collapsed) .toggle::after { content: 'ocultar'; }

        /* Shopping list */
        .shopping-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #222;
            font-size: 14px;
        }
        .shopping-item:last-child { border-bottom: none; }
        .shopping-item .name { color: #e0e0e0; }
        .shopping-item .qty { color: #f59e0b; font-weight: 600; font-size: 13px; }
        .shopping-item .expiry-warn { color: #ef4444; font-size: 12px; }
        .shopping-empty { color: #444; font-size: 14px; padding: 8px 0; }

        /* Scanner */
        .barcode-input {
            display: flex;
            gap: 8px;
        }
        .barcode-input input {
            flex: 1;
            background: #111;
            border: 1px solid #333;
            color: #fff;
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 15px;
        }
        .barcode-input input:focus { outline: none; border-color: #555; }
        .barcode-input input::placeholder { color: #444; }

        .camera-row {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        #scanner-container {
            width: 100%;
            max-width: 400px;
            margin: 12px auto;
            border-radius: 8px;
            overflow: hidden;
        }

        /* Buttons */
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .btn:active { opacity: 0.7; }
        .btn-primary { background: #333; color: #fff; }
        .btn-add { background: #166534; color: #4ade80; }
        .btn-remove { background: #7f1d1d; color: #f87171; }

        /* Product form */
        #product-action { margin-top: 12px; }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .form-grid .full { grid-column: 1 / -1; }
        .form-group label { display: block; font-size: 12px; color: #666; margin-bottom: 4px; }
        .form-group input, .form-group select {
            width: 100%;
            background: #111;
            border: 1px solid #333;
            color: #fff;
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 14px;
        }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #555; }
        .form-group select option { background: #1a1a1a; }
        .form-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .form-actions .btn { flex: 1; }

        #scanned-code {
            background: #1a2e1a;
            border: 1px solid #2d4a2d;
            color: #4ade80;
            padding: 8px 12px;
            border-radius: 6px;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        /* Product list */
        .product-row {
            padding: 10px 0;
            border-bottom: 1px solid #222;
        }
        .product-row:last-child { border-bottom: none; }
        .product-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }
        .product-main { flex: 1; min-width: 0; }
        .product-main .name { font-size: 15px; color: #e0e0e0; font-weight: 500; }
        .product-main .meta { font-size: 12px; color: #555; margin-top: 2px; }
        .product-stock {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }
        .stock-num {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
            min-width: 28px;
            text-align: center;
        }
        .stock-num.low { color: #f59e0b; }
        .btn-round {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid #333;
            background: #222;
            color: #aaa;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
        }
        .btn-round:active { opacity: 0.6; }
        .btn-round.add { border-color: #166534; color: #4ade80; }
        .btn-round.remove { border-color: #7f1d1d; color: #f87171; }
        .btn-del {
            background: none;
            border: none;
            color: #444;
            cursor: pointer;
            font-size: 14px;
            padding: 4px;
        }
        .btn-del:hover { color: #ef4444; }

        /* Batches */
        .batch-list {
            margin-top: 6px;
            padding-left: 8px;
            border-left: 2px solid #222;
        }
        .batch-row {
            font-size: 12px;
            color: #555;
            padding: 2px 0;
            display: flex;
            gap: 8px;
        }
        .batch-row .batch-qty { color: #888; font-weight: 600; min-width: 40px; }
        .batch-row .expiry-ok { color: #555; }
        .batch-row .expiry-soon { color: #f59e0b; }
        .batch-row .expiry-expired { color: #ef4444; }

        .empty-state { color: #444; font-size: 14px; padding: 12px 0; text-align: center; }

        .hidden { display: none; }

        @media (max-width: 500px) {
            .form-grid { grid-template-columns: 1fr; }
            .form-grid .full { grid-column: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Stock Manager</h1>
            <small>v0.2.0</small>
        </div>

        <!-- Stats -->
        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="total-products">0</div>
                <div class="stat-label">Productos</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="total-items">0</div>
                <div class="stat-label">Unidades</div>
            </div>
            <div class="stat warning">
                <div class="stat-value" id="low-stock-count">0</div>
                <div class="stat-label">Faltan</div>
            </div>
        </div>

        <!-- Necesitas comprar -->
        <div class="section" id="shopping-section">
            <div class="section-header" onclick="toggleSection('shopping-section')">
                <h2>Necesitas comprar</h2>
                <span class="toggle"></span>
            </div>
            <div class="section-body">
                <div id="shopping-list"></div>
            </div>
        </div>

        <!-- Escanear / Añadir -->
        <div class="section" id="scanner-section">
            <div class="section-header" onclick="toggleSection('scanner-section')">
                <h2>Escanear / Añadir</h2>
                <span class="toggle"></span>
            </div>
            <div class="section-body">
                <div class="barcode-input">
                    <input type="text" id="manual-barcode" placeholder="Código de barras" inputmode="numeric">
                    <button class="btn btn-primary" onclick="useManualBarcode()">Buscar</button>
                </div>
                <div class="camera-row">
                    <button class="btn btn-primary" id="start-scan" style="flex:1">Iniciar Cámara</button>
                    <button class="btn btn-remove hidden" id="stop-scan" style="flex:1">Detener</button>
                </div>
                <div id="scanner-container"></div>
                <div id="scanned-code" class="hidden"></div>

                <div id="product-action" class="hidden">
                    <div class="form-grid">
                        <div class="form-group full">
                            <label>Nombre</label>
                            <input type="text" id="product-name" placeholder="Ej: Leche Entera">
                        </div>
                        <div class="form-group">
                            <label>Categoría</label>
                            <select id="product-category">
                                <option value="Alimentos">Alimentos</option>
                                <option value="Bebidas">Bebidas</option>
                                <option value="Limpieza">Limpieza</option>
                                <option value="Higiene">Higiene Personal</option>
                                <option value="Otros">Otros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Stock Mínimo</label>
                            <input type="number" id="min-stock" value="2" min="1">
                        </div>
                        <div class="form-group">
                            <label>Caducidad</label>
                            <input type="date" id="expiry-date">
                        </div>
                        <div class="form-group">
                            <label>Cantidad</label>
                            <input type="number" id="quantity" value="1" min="1">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-add" onclick="addStock()">Añadir</button>
                        <button class="btn btn-remove" onclick="removeStock()">Consumir</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventario -->
        <div class="section" id="inventory-section">
            <div class="section-header" onclick="toggleSection('inventory-section')">
                <h2>Inventario</h2>
                <span class="toggle"></span>
            </div>
            <div class="section-body">
                <div id="product-list"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = `${window.location.pathname.replace(/\/$/, '')}/api`;
        let html5QrCode;
        let products = [];
        let currentBarcode = null;

        window.onload = async function() {
            await loadProducts();
        };

        function toggleSection(id) {
            document.getElementById(id).classList.toggle('collapsed');
        }

        // API
        async function apiCall(endpoint, method = 'GET', body = null) {
            const options = { method, headers: { 'Content-Type': 'application/json' } };
            if (body) options.body = JSON.stringify(body);
            const url = `${API_BASE}${endpoint}`;
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    const text = await response.text().catch(() => '');
                    let msg;
                    try { msg = JSON.parse(text).detail || `Error ${response.status}`; }
                    catch { msg = `Error ${response.status}: ${text.substring(0, 200) || response.statusText}`; }
                    throw new Error(msg);
                }
                if (method === 'DELETE') return true;
                return await response.json().catch(() => { throw new Error('Respuesta inválida'); });
            } catch (error) {
                console.error(`API Error [${method} ${url}]:`, error);
                alert(error.message);
                throw error;
            }
        }

        async function loadProducts() {
            try {
                products = await apiCall('/products');
                updateUI();
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        async function loadStats() {
            try { return await apiCall('/stats'); }
            catch { return { total_products: 0, total_units: 0, low_stock_count: 0 }; }
        }

        // Scanner
        document.getElementById('start-scan').onclick = async function() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Cámara no disponible. Se requiere HTTPS.');
                }
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                stream.getTracks().forEach(track => track.stop());
                html5QrCode = new Html5Qrcode("scanner-container");
                await html5QrCode.start(
                    { facingMode: "environment" },
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    onScanSuccess
                );
                document.getElementById('start-scan').classList.add('hidden');
                document.getElementById('stop-scan').classList.remove('hidden');
            } catch (err) {
                alert('Error cámara: ' + err.message);
            }
        };

        document.getElementById('stop-scan').onclick = function() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('start-scan').classList.remove('hidden');
                    document.getElementById('stop-scan').classList.add('hidden');
                });
            }
        };

        function useManualBarcode() {
            const barcode = document.getElementById('manual-barcode').value.trim();
            if (!barcode) { alert('Introduce un código'); return; }
            onScanSuccess(barcode);
            document.getElementById('manual-barcode').value = '';
        }

        function onScanSuccess(decodedText) {
            currentBarcode = decodedText;
            document.getElementById('scanned-code').textContent = 'Código: ' + decodedText;
            document.getElementById('scanned-code').classList.remove('hidden');
            document.getElementById('product-action').classList.remove('hidden');

            const product = products.find(p => p.barcode === currentBarcode);
            if (product) {
                document.getElementById('product-name').value = product.name;
                document.getElementById('product-category').value = product.category;
                document.getElementById('min-stock').value = product.min_stock;
            } else {
                document.getElementById('product-name').value = '';
                document.getElementById('min-stock').value = 2;
            }
            document.getElementById('expiry-date').value = '';

            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    document.getElementById('start-scan').classList.remove('hidden');
                    document.getElementById('stop-scan').classList.add('hidden');
                });
            }
        }

        async function addStock() {
            if (!currentBarcode) return;
            const name = document.getElementById('product-name').value.trim();
            const category = document.getElementById('product-category').value;
            const minStock = parseInt(document.getElementById('min-stock').value);
            const expiryDate = document.getElementById('expiry-date').value || null;
            const quantity = parseInt(document.getElementById('quantity').value);
            if (!name) { alert('Introduce el nombre del producto'); return; }
            try {
                const product = products.find(p => p.barcode === currentBarcode);
                if (!product) {
                    await apiCall('/products', 'POST', {
                        barcode: currentBarcode, name, category, min_stock: minStock
                    });
                }
                await apiCall(`/products/${currentBarcode}/stock`, 'POST', {
                    quantity, expiry_date: expiryDate
                });
                await loadProducts();
                resetScanner();
            } catch (error) {
                console.error('Error adding stock:', error);
            }
        }

        async function removeStock() {
            if (!currentBarcode) return;
            const quantity = parseInt(document.getElementById('quantity').value);
            const product = products.find(p => p.barcode === currentBarcode);
            if (!product) { alert('Producto no encontrado'); return; }
            if (product.stock < quantity) { alert('No hay suficiente stock'); return; }
            try {
                await apiCall(`/products/${currentBarcode}/stock`, 'POST', { quantity: -quantity });
                await loadProducts();
                resetScanner();
            } catch (error) {
                console.error('Error removing stock:', error);
            }
        }

        function resetScanner() {
            currentBarcode = null;
            document.getElementById('scanned-code').classList.add('hidden');
            document.getElementById('product-action').classList.add('hidden');
            document.getElementById('quantity').value = 1;
            document.getElementById('expiry-date').value = '';
        }

        async function deleteProduct(barcode) {
            if (confirm('¿Eliminar este producto?')) {
                try {
                    await apiCall(`/products/${barcode}`, 'DELETE');
                    await loadProducts();
                } catch (error) {
                    console.error('Error deleting product:', error);
                }
            }
        }

        async function quickAdd(barcode) {
            try {
                await apiCall(`/products/${barcode}/stock`, 'POST', { quantity: 1 });
                await loadProducts();
            } catch (error) { console.error('Error:', error); }
        }

        async function quickRemove(barcode) {
            const product = products.find(p => p.barcode === barcode);
            if (product && product.stock > 0) {
                try {
                    await apiCall(`/products/${barcode}/stock`, 'POST', { quantity: -1 });
                    await loadProducts();
                } catch (error) { console.error('Error:', error); }
            }
        }

        // UI
        async function updateUI() {
            const stats = await loadStats();
            document.getElementById('total-products').textContent = stats.total_products;
            document.getElementById('total-items').textContent = stats.total_units;
            document.getElementById('low-stock-count').textContent = stats.low_stock_count;
            updateShoppingList();
            updateProductList();
        }

        function getExpiryInfo(expiryDate) {
            if (!expiryDate) return null;
            const today = new Date(); today.setHours(0,0,0,0);
            const expiry = new Date(expiryDate + 'T00:00:00');
            const daysLeft = Math.ceil((expiry - today) / 86400000);
            if (daysLeft < 0) return { text: 'CADUCADO', cls: 'expiry-expired' };
            if (daysLeft === 0) return { text: 'Caduca HOY', cls: 'expiry-expired' };
            if (daysLeft <= 7) return { text: `Caduca en ${daysLeft}d`, cls: 'expiry-soon' };
            return { text: `Cad: ${expiry.toLocaleDateString('es-ES')}`, cls: 'expiry-ok' };
        }

        function updateShoppingList() {
            const list = document.getElementById('shopping-list');
            const lowStock = products.filter(p => p.stock <= p.min_stock);

            if (lowStock.length === 0) {
                list.innerHTML = '<div class="shopping-empty">Todo en orden</div>';
                return;
            }

            list.innerHTML = lowStock.map(p => {
                const needed = p.min_stock - p.stock + 2;
                const exp = getExpiryInfo(p.expiry_date);
                const expiryHtml = exp && (exp.cls !== 'expiry-ok')
                    ? ` <span class="expiry-warn">${exp.text}</span>` : '';
                return `<div class="shopping-item">
                    <span class="name">${p.name}${expiryHtml}</span>
                    <span class="qty">${needed} uds</span>
                </div>`;
            }).join('');
        }

        function updateProductList() {
            const list = document.getElementById('product-list');
            if (products.length === 0) {
                list.innerHTML = '<div class="empty-state">Sin productos. Escanea para empezar.</div>';
                return;
            }

            products.sort((a, b) => {
                const aLow = a.stock <= a.min_stock;
                const bLow = b.stock <= b.min_stock;
                if (aLow && !bLow) return -1;
                if (!aLow && bLow) return 1;
                return a.name.localeCompare(b.name);
            });

            list.innerHTML = products.map(p => {
                const isLow = p.stock <= p.min_stock;
                // Batch breakdown
                let batchHtml = '';
                if (p.batches && p.batches.length > 0) {
                    const batchRows = p.batches.map(b => {
                        const exp = getExpiryInfo(b.expiry_date);
                        const expText = exp
                            ? `<span class="${exp.cls}">${exp.text}</span>`
                            : '<span class="expiry-ok">Sin caducidad</span>';
                        return `<div class="batch-row">
                            <span class="batch-qty">${b.quantity} ud${b.quantity > 1 ? 's' : ''}</span>
                            ${expText}
                        </div>`;
                    }).join('');
                    batchHtml = `<div class="batch-list">${batchRows}</div>`;
                }
                return `<div class="product-row">
                    <div class="product-top">
                        <div class="product-main">
                            <div class="name">${p.name}</div>
                            <div class="meta">${p.category}</div>
                        </div>
                        <div class="product-stock">
                            <button class="btn-round remove" onclick="quickRemove('${p.barcode}')">-</button>
                            <span class="stock-num ${isLow ? 'low' : ''}">${p.stock}</span>
                            <button class="btn-round add" onclick="quickAdd('${p.barcode}')">+</button>
                            <button class="btn-del" onclick="deleteProduct('${p.barcode}')" title="Eliminar">&#x2715;</button>
                        </div>
                    </div>
                    ${batchHtml}
                </div>`;
            }).join('');
        }
    </script>
</body>
</html>
